import streamlit as st
import swisseph as swe
import matplotlib.pyplot as plt
import numpy as np
import datetime
import os
import matplotlib.font_manager as fm
import urllib.request

# --- ページ基本設定 ---
st.set_page_config(page_title="星読みWebアプリ", layout="wide")

# --- 【最強豆腐対策】フォントの強制適用 ---
@st.cache_resource
def get_japanese_font():
    # Noto Sans JPをダウンロード
    font_url = "https://github.com/googlefonts/noto-cjk/raw/main/Sans/OTF/Japanese/NotoSansCJKjp-Regular.otf"
    font_path = "NotoSansCJKjp.otf"
    if not os.path.exists(font_path):
        urllib.request.urlretrieve(font_url, font_path)
    return font_path

try:
    f_path = get_japanese_font()
    jp_font = fm.FontProperties(fname=f_path)
    # システム全体にも登録
    fm.fontManager.addfont(f_path)
    plt.rcParams['font.family'] = jp_font.get_name()
except:
    jp_font = None # 失敗した時の保険

# --- データベース ---
CITY_DB = {
    "北海道": (43.0641, 141.3469), "青森": (40.8244, 140.74), "岩手": (39.7036, 141.1527), "宮城": (38.2682, 140.8694),
    "秋田": (39.7186, 140.1023), "山形": (38.2554, 140.3396), "福島": (37.7503, 140.4675), "茨城": (36.3418, 140.4468),
    "栃木": (36.5658, 139.8836), "群馬": (36.3895, 139.0634), "埼玉": (35.8569, 139.6489), "千葉": (35.6047, 140.1233),
    "東京": (35.6895, 139.6917), "神奈川": (35.4478, 139.6425), "新潟": (37.9162, 139.0364), "富山": (36.6953, 137.2113),
    "石川": (36.5613, 136.6562), "福井": (36.0641, 136.2196), "山梨": (35.6622, 138.5683), "長野": (36.6485, 138.1942),
    "岐阜": (35.4233, 136.7607), "静岡": (34.9756, 138.3828), "愛知": (35.1802, 136.9066), "三重": (34.7186, 136.5053),
    "滋賀": (35.0045, 135.8686), "京都": (35.0116, 135.7681), "大阪": (34.6937, 135.5023), "兵庫": (34.6913, 135.183),
    "奈良": (34.6851, 135.8327), "和歌山": (34.2305, 135.1708), "鳥取": (35.5011, 134.2351), "島根": (35.4722, 133.0505),
    "岡山": (34.6618, 133.9347), "広島": (34.3853, 132.4553), "山口": (34.1785, 131.4737), "徳島": (34.0703, 134.5548),
    "香川": (34.3401, 134.0433), "愛媛": (33.8392, 132.7656), "高知": (33.5597, 133.5311), "福岡": (33.5904, 130.4017),
    "佐賀": (33.2635, 130.3009), "長崎": (32.7501, 129.8773), "熊本": (32.8032, 130.7079), "大分": (33.2382, 131.6126),
    "宮崎": (31.9077, 131.4202), "鹿児島": (31.5966, 130.5571), "沖縄": (26.2124, 127.6809)
}

SABIAN_DATA = {
    "牡羊座": ["海から上がったアザラシ", "面白半分に話している男", "カメオの中の男の横顔", "恋人に服を貸す男", "羽のある三角", "正方形の一辺が明るく輝く", "二つの領域に同時に表現", "風に舞うリボン", "水晶を凝視する人", "教育的な象徴の学派", "国の支配者", "野生の鴨の群れ", "成功した引退", "蛇を巻く蛇使い", "布を織るインド人", "精霊の舞踏", "二人の老嬢", "空のハンモック", "魔法の絨毯", "冬に鳥に餌をやる少女", "拳闘士", "欲望の門", "重い荷物を運ぶパステル服の女", "開いた窓と風に吹かれるカーテン", "二重の約束", "持ちきれない贈り物を抱える男", "想像力の機会", "落胆した多くの聴衆", "天球の合唱", "アヒルの池と雛"],
    "牡牛座": ["清らかな山の泉", "電気的な嵐", "クローバーの咲く原っぱのステップ", "虹のふもとの黄金の壺", "未亡人の墓の前の未開拓の場所", "峡谷にかかる橋", "サマリアの女", "雪がまだ降っていないソリ", "飾られたクリスマスツリー", "赤十字の看護婦", "花の庭に水をやる女", "ウィンドウショッピング", "荷物を運ぶポーター", "模索している貝殻と子供たち", "マフラーを巻いた粋なシルクハットの男", "古い神秘的な書物を扱う老人", "剣と松明の間の戦い", "袋を窓の外で振る女", "新しい大陸を指し示す大陸の海", "雲を突き抜ける光の柱", "開いた本を指し示す指", "白い鳩が水の上を飛ぶ", "宝石店", "インドの宝石", "大きく手入れされた公園", "恋人にセレナーデを歌うスペイン人", "古いビーズ細工のバッグ", "成熟したロマンスの淑女", "二つの靴の修繕屋", "孔雀がテラスで羽を広げる"],
    "双子座": ["ガラス底ボート", "サンタクロースの靴下", "テュイルリー庭園", "ヒイラギとヤドリギ", "過激な雑誌", "油田の掘削", "古い井戸", "労働者のストライキ", "矢筒を満たした矢", "落下する飛行機", "体験の真実を告げる道", "奴隷の少女たち", "有名なピアニスト", "テレパシーでの会話", "二人のオランダの子供", "婦人参政権論者", "知力と健康の頭", "中国の通訳", "大きな古典的な本", "カフェテリア", "労働者のデモ", "ダンスカップル", "高い所にある鳥の巣", "氷を切り出す男", "パームビーチの庭師", "霜でおおわれた森", "森から出てくるジプシー", "破産宣告された男", "最初のシロツメクサ", "海水浴場"],
    "蟹座": ["船に掲げられた旗", "広く平らな吊るし船", "毛皮を着た男", "ねずみと議論する猫", "踏切で破壊される列車", "巣を作る猟犬", "妖精の巣", "服を着たウサギ", "魚を釣る裸の少女", "ダイヤモンドのカット", "しかめ面をするピエロ", "メッセージを隠した女性", "目立つ手の一本の指", "暗闇を突く明るい光", "贅沢な食事", "手袋をはめる男", "潜在意識の原形", "雛に餌をやる雌鶏", "結婚の儀式", "ゴンドラ乗り", "歌っている有名な歌手", "文学会の集まり", "南の島の小さな島", "意志の力の影", "ゲストをもてなす図書館員", "渓谷にある激流", "現代のミューズ", "双子の結婚", "アメリカ革命の娘"],
    "獅子座": ["脳出血の症例", "おたふく風邪の流行", "髪を短く刈り上げた女", "正装した男と鹿", "絶壁の端にある岩", "時代のファッションショー", "空の星座", "共産主義のプロパガンダ", "吹きガラスの職人", "早朝の露", "大きな樫の木の下のブランコ", "パーティーで大声を出す大人", "揺れる老いた船長", "受肉を求める魂", "山から降りてくるパレード", "日の出の熱狂", "ボランティアの合唱隊", "化学の先生", "ハウスボートのパーティー", "太陽の崇拝者", "中毒した鶏", "伝書鳩", "裸の馬乗り", "身なりを整えない男", "砂漠を渡るラクダ", "虹", "夜明け", "木に止まったたくさんの鳥", "人魚", "開封された手紙"],
    "乙女座": ["男の頭", "大きな十字架", "守護天使", "白人と黒人の子供", "妖精の夢を見る男", "メリーゴーラウンド", "ハーレム", "最初のダンスの練習", "未来派の画家", "影の向こうを見る男", "期待に応える少年", "ヴェールを剥がされた花嫁", "強い政治的な騒動", "家系図", "装飾的なハンカチ", "オランニエ公の子供たち", "火山の爆発", "ウィジャ盤", "水泳競技", "キャラバン", "バスケットボールチーム", "王室の紋章", "ライオンの調教師", "メアリーと彼女の子羊", "半旗", "香炉を持った少年", "お茶会", "禿げた男", "読書する女性", "聞き耳を立てる隣人"],
    "天秤座": ["突き通された蝶", "光が屈折する六角形", "新しい日の出", "キャンプファイヤー", "内面的な知恵を教える男", "結晶の形成", "ヒヨコに餌をやる女", "荒廃した家の灯火", "三枚の巨匠の絵", "危険な急流を抜ける", "眼鏡をかけ直す教授", "坑道から出る鉱夫", "シャボン玉を吹く子供", "正午の休息", "環状の道", "流された桟橋", "引退した船長", "逮捕された二人組", "強盗に立ち向かうギャング", "ユダヤ人のラビ", "砂の上の子供たち", "小鳥に水をやる子供", "おんどりの鳴き声", "左側の意志の力の影", "秋の葉の情景", "鷹と白い鳩", "舞い上がる飛行機", "明るい光の中の男の頭", "三つの古い知恵", "哲学者の頭"],
    "蠍座": ["観光バス", "割れた瓶と録音機", "棟上げ式", "若々しいロウソクの光", "大きな岩場の海岸", "ゴールドラッシュ", "深海潜水夫", "湖の静かな月光", "歯科工作", "親睦会の夕食会", "溺れた男の救助", "大使館の舞踏会", "実験室の発明家", "電話の設置", "五つの砂の山", "微笑んでいる少女", "子供の父である女", "豪華な秋の小道", "聴診器を当てる耳", "カーテンを引く女", "職務放棄した兵士", "鴨を撃つハンター", "ウサギに変容する霊", "聞いた話を喋る女", "エックス線写真", "インディアンのキャンプ", "軍楽隊", "妖精の王", "社交的な孔雀", "ハロウィンの道化"],
    "射手座": ["軍隊のキャンプ", "白波に覆われた大洋", "チェスのプレーヤー", "子供と歩く小さな犬", "古いフクロウ", "クリケットの試合", "ドアを叩くキューピッド", "岩の中の住居", "母親に連れられる子供", "黄金の翼を持つ鳥", "左側の意志の力の影", "旗を振る情景", "未亡人の過去", "ピラミッドとスフィンクス", "自分の影を探すグラウンドホッグ", "船を見守るカモメ", "日の出の礼拝", "帽子をかぶった子供", "ペリカンの家", "氷の上で遊ぶ子供たち", "借りた眼鏡をかける子供", "中国の洗濯屋", "移民が入国する", "家の玄関の青い鳥", "おもちゃの馬少年", "旗手", "彫刻家", "橋を渡る馬車", "芝生を刈る男", "法王"],
    "山羊座": ["部族の酋長", "三つのステンドグラス", "受難の末の勝利", "カヌーに乗るインディアン", "カヌーを漕ぐインディアン", "アーダーの下の丸太", "ヴェールを被った預言者", "家鳥のさえずり", "ハープを運る天使", "移動するアホウドリ", "私有地のキジ", "自然の科学者", "火を拝む信者", "古代の浮き彫り", "子供たちのための病室", "体操着の少年少女", "日光浴をする女", "イギリスの国旗", "子供を運ぶ少女", "隠れた合唱隊", "リレー競走", "敗北を認める将軍", "歌っている二羽の小鳥", "修道院に入る女", "絨毯を扱う商人", "水の妖精", "山の巡礼", "大きな養生所", "お茶の葉を読んでいる女", "秘密のビジネス会議"],
    "水瓶座": ["アドベのミッション", "予期せぬ雷雨", "脱走兵の海軍兵士", "ヒンドゥー教のヒーラー", "先祖の委員会", "仮面の人物", "卵から生まれた子供", "展示用のマネキン", "旗を振る情景", "人気の絶頂", "沈黙を保つ男", "階段で踊る人々", "バロメーター", "大きな砂時計", "二羽の愛の鳥", "偉大な実業家", "ガードをしている番犬", "仮面を剥がされた人物", "消火作業員", "白い鳩の使者", "絶望して幻滅した女", "子供たちのための敷物", "訓練された番犬", "情熱に背を向ける男", "右側の意志の力の影", "水圧計", "古代の陶器", "倒された木と薪", "さなぎから出る蝶", "アーダスの咲く草原"],
    "魚座": ["混雑した市場", "隠れているリス", "石化した森", "細い小道", "教会のバザー", "正装したパレード", "宗教的な行進", "ラッパを吹く少女", "騎手", "雲の向こうの太陽", "光を探している男たち", "新月を指す剣", "博物館の刀", "狐を狩る女", "揺れている避難所", "静かな流れを渡る夕食", "復活祭のプロムナード", "巨大なテント", "弟子の訓練", "夕食のテーブル", "白い子羊に先導される少女", "シナイ山の預言者", "精神的な具現化", "住み心地の良い家", "聖職の清め", "二人の恋人と月光", "収穫の月", "肥沃な庭", "光が屈折するプリズム", "巨大な岩の面"]
}

def calc_pos(y, m, d, h, mi):
    jd_ut = swe.julday(y, m, d, (h + mi/60.0) - 9)
    p_map = {"SUN":0, "MOON":1, "MER":2, "VEN":3, "MAR":4, "JUP":5, "SAT":6, "URA":7, "NEP":8, "PLU":9}
    p_names = {"SUN":"太陽", "MOON":"月", "MER":"水星", "VEN":"金星", "MAR":"火星", "JUP":"木星", "SAT":"土星", "URA":"天王星", "NEP":"海王星", "PLU":"冥王星"}
    res = {}
    for k, v in p_map.items():
        res[k] = {"deg": swe.calc_ut(jd_ut, v)[0][0], "name_jp": p_names[k]}
    return res, jd_ut

st.title("🌟 鑑定用ホロスコープ")
st.sidebar.title("🛠️ 設定パネル")

n_date = st.sidebar.date_input("出生日", datetime.date(1990, 1, 1))
n_time = st.sidebar.time_input("時刻", datetime.time(12, 0))
place_name = st.sidebar.selectbox("生まれた場所", list(CITY_DB.keys()), index=12)
t_mode = st.sidebar.radio("モード", ["ネイタル", "重ね表示", "トランジットのみ"])

z_jp = ["牡羊座", "牡牛座", "双子座", "蟹座", "獅子座", "乙女座", "天秤座", "蠍座", "射手座", "山羊座", "水瓶座", "魚座"]
lat, lon = CITY_DB[place_name]
n_pos, n_jd = calc_pos(n_date.year, n_date.month, n_date.day, n_time.hour, n_time.minute)
cusps, ascmc = swe.houses(n_jd, lat, lon, b'P')

fig = plt.figure(figsize=(10, 8))
ax = fig.add_subplot(111, projection='polar')
ax.set_theta_direction(1)
ax.set_theta_zero_location("W")

# --- 描画時にフォントを直接指定 ---
font_args = {"fontproperties": jp_font} if jp_font else {}

for i in range(12):
    theta = np.deg2rad(i * 30)
    ax.plot([theta, theta], [0, 1.2], color="#ddd", lw=1)
    ax.text(theta + np.deg2rad(15), 1.3, z_jp[i], ha='center', va='center', **font_args)

if t_mode in ["ネイタル", "重ね表示"]:
    for i, c in enumerate(cusps):
        theta = np.deg2rad(c)
        ax.plot([theta, theta], [0, 1.0], color="gray", linestyle="--", alpha=0.5)
    for k, v in n_pos.items():
        theta = np.deg2rad(v['deg'])
        ax.plot(theta, 0.7, 'ko')
        ax.text(theta, 0.6, v['name_jp'], ha='center', **font_args)

if t_mode in ["重ね表示", "トランジットのみ"]:
    now = datetime.datetime.now()
    t_pos, _ = calc_pos(now.year, now.month, now.day, now.hour, now.minute)
    for k, v in t_pos.items():
        theta = np.deg2rad(v['deg'])
        r = 0.7 if t_mode == "トランジットのみ" else 0.9
        ax.plot(theta, r, 'ro', markerfacecolor='white')
        ax.text(theta, r+0.1, v['name_jp'], color='red', ha='center', **font_args)

st.pyplot(fig)

st.divider()
st.subheader("📜 サビアンシンボル")
target_pos = n_pos if t_mode != "トランジットのみ" else t_pos
for k, v in target_pos.items():
    s_idx = int(v['deg'] // 30)
    s_deg = int(v['deg'] % 30) + 1
    sign = z_jp[s_idx]
    st.write(f"**{v['name_jp']}**: {sign} {s_deg}度 『{SABIAN_DATA[sign][s_deg-1]}』")
